name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up environment variables
        run: |
          # The secrets are passed from the GitHub environment variables
          touch .env
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> .env
          echo "CHANNEL_ID=313397112777867264" >> .env
          # Note: The migration service in compose.test.yaml overrides this with the service name
          echo "DB_CONNECTION_URL=postgresql+psycopg2://postgres:postgres@localhost:5432/bazelbot_db" >> .env
          echo "MAX_BAZEL_LENGTH=30" >> .env
          echo "MESSAGE_LIMIT=10000" >> .env
          echo "RATE_LIMIT=20" >> .env
          echo "MAX_BAZELS_IN_CONTEXT=25" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "GEMINI_MODEL=gemini-2.0-flash-exp" >> .env
          echo "BAZEL_IMAGE_WIDTH=350" >> .env
          echo "BAZEL_IMAGE_HEIGHT=350" >> .env
          echo "BAZEL_FLAVOUR_VARIETY=20" >> .env
          echo "BAZEL_IMAGE_SAVE_PATH=data" >> .env

      - name: Install Python and Poetry
        uses: actions/setup-python@v3
        with:
          python-version: '3.12'

      - run: pip install poetry
      - run: poetry install

      # --- Docker Setup and Debugging ---

      - name: Clean up old containers and volumes (Crucial for fresh DB state)
        # down -v removes volumes, ensuring a clean start for the DB container
        run: docker compose -f compose.test.yaml down -v --remove-orphans || true

      - name: Create docker containers
        run: docker compose -f compose.test.yaml up -d

      - name: Get Database Container Logs (Primary Debug Step)
        # This step runs even if the previous step failed, capturing the error logs
        if: always()
        run: |
          echo "--- DATABASE CONTAINER LOGS (bazelbot-db-1) ---"
          docker logs bazelbot-db-1
          echo "------------------------------------------------"

      - name: Wait for Database (Explicit Wait)
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          # Explicitly check for DB readiness using the same user defined in the compose file
          for i in {1..15}; do
            docker exec bazelbot-db-1 pg_isready -U postgres
            if [ $? -eq 0 ]; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Attempt $i/15: DB not ready, waiting 5 seconds..."
            sleep 5
          done

      # --- Code Quality Checks and Tests ---

      - name: Check running containers
        run: docker ps -a

      - name: Run Ruff Check
        run: poetry run ruff check .

      - name: Run Black Check
        run: poetry run black --check .

      - name: Run Pytest
        run: poetry run pytest -s -v -m "not llm"